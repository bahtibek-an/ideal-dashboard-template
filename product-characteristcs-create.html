<!doctype html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Создание продукта</title>
    <link href="https://cdn.jsdelivr.net/npm/flowbite@2.4.1/dist/flowbite.min.css" rel="stylesheet"/>
    <script src="https://cdn.jsdelivr.net/npm/flowbite@2.4.1/dist/flowbite.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/redux/4.0.5/redux.min.js"></script>
</head>
</head>
<body class="p-5 bg-white dark:bg-gray-900 antialiased !p-0">

<button data-drawer-target="sidebar-multi-level-sidebar" data-drawer-toggle="sidebar-multi-level-sidebar"
        aria-controls="sidebar-multi-level-sidebar" type="button"
        class="inline-flex items-center p-2 mt-2 ms-3 text-sm text-gray-500 rounded-lg sm:hidden hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-200 dark:text-gray-400 dark:hover:bg-gray-700 dark:focus:ring-gray-600">
    <span class="sr-only">Open sidebar</span>
    <svg class="w-6 h-6" aria-hidden="true" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
        <path clip-rule="evenodd" fill-rule="evenodd"
              d="M2 4.75A.75.75 0 012.75 4h14.5a.75.75 0 010 1.5H2.75A.75.75 0 012 4.75zm0 10.5a.75.75 0 01.75-.75h7.5a.75.75 0 010 1.5h-7.5a.75.75 0 01-.75-.75zM2 10a.75.75 0 01.75-.75h14.5a.75.75 0 010 1.5H2.75A.75.75 0 012 10z"></path>
    </svg>
</button>

<aside id="sidebar-multi-level-sidebar"
       class="fixed top-0 left-0 z-40 w-64 h-screen transition-transform -translate-x-full sm:translate-x-0"
       aria-label="Sidebar">
    <div class="h-full px-3 py-4 overflow-y-auto bg-gray-50 dark:bg-gray-800">
        <div class="mb-6 mt-4 ">
            <img src="./assets/logo-red.png" alt="logo red"/>
        </div>
        <ul class="space-y-2 font-medium">
            <li>
                <a href="./products.html"
                   class="flex items-center p-2 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 group dark:bg-gray-700">

                    <svg class="w-5 h-5 text-gray-500 transition duration-75 dark:text-gray-400 group-hover:text-gray-900 dark:group-hover:text-white"
                         xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 576 512">
                        <path d="M253.3 35.1c6.1-11.8 1.5-26.3-10.2-32.4s-26.3-1.5-32.4 10.2L117.6 192 32 192c-17.7 0-32 14.3-32 32s14.3 32 32 32L83.9 463.5C91 492 116.6 512 146 512L430 512c29.4 0 55-20 62.1-48.5L544 256c17.7 0 32-14.3 32-32s-14.3-32-32-32l-85.6 0L365.3 12.9C359.2 1.2 344.7-3.4 332.9 2.7s-16.3 20.6-10.2 32.4L404.3 192l-232.6 0L253.3 35.1zM192 304l0 96c0 8.8-7.2 16-16 16s-16-7.2-16-16l0-96c0-8.8 7.2-16 16-16s16 7.2 16 16zm96-16c8.8 0 16 7.2 16 16l0 96c0 8.8-7.2 16-16 16s-16-7.2-16-16l0-96c0-8.8 7.2-16 16-16zm128 16l0 96c0 8.8-7.2 16-16 16s-16-7.2-16-16l0-96c0-8.8 7.2-16 16-16s16 7.2 16 16z"/>
                    </svg>
                    <span class="ms-3">Продукты</span>
                </a>
            </li>
            <li>
                <a href="./category.html"
                   class="flex items-center p-2 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 group">
                    <svg class="w-5 h-5 text-gray-500 transition duration-75 dark:text-gray-400 group-hover:text-gray-900 dark:group-hover:text-white"
                         aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 22 21">
                        <path d="M16.975 11H10V4.025a1 1 0 0 0-1.066-.998 8.5 8.5 0 1 0 9.039 9.039.999.999 0 0 0-1-1.066h.002Z"/>
                        <path d="M12.5 0c-.157 0-.311.01-.565.027A1 1 0 0 0 11 1.02V10h8.975a1 1 0 0 0 1-.935c.013-.188.028-.374.028-.565A8.51 8.51 0 0 0 12.5 0Z"/>
                    </svg>
                    <span class="ms-3">Категории</span>
                </a>
            </li>
            <li>
                <a href="./about-us.html"
                   class="flex items-center p-2 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 group">
                    <svg class="flex-shrink-0 w-5 h-5 text-gray-500 transition duration-75 dark:text-gray-400 group-hover:text-gray-900 dark:group-hover:text-white"
                         aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 18 18">
                        <path d="M6.143 0H1.857A1.857 1.857 0 0 0 0 1.857v4.286C0 7.169.831 8 1.857 8h4.286A1.857 1.857 0 0 0 8 6.143V1.857A1.857 1.857 0 0 0 6.143 0Zm10 0h-4.286A1.857 1.857 0 0 0 10 1.857v4.286C10 7.169 10.831 8 11.857 8h4.286A1.857 1.857 0 0 0 18 6.143V1.857A1.857 1.857 0 0 0 16.143 0Zm-10 10H1.857A1.857 1.857 0 0 0 0 11.857v4.286C0 17.169.831 18 1.857 18h4.286A1.857 1.857 0 0 0 8 16.143v-4.286A1.857 1.857 0 0 0 6.143 10Zm10 0h-4.286A1.857 1.857 0 0 0 10 11.857v4.286c0 1.026.831 1.857 1.857 1.857h4.286A1.857 1.857 0 0 0 18 16.143v-4.286A1.857 1.857 0 0 0 16.143 10Z"/>
                    </svg>
                    <span class="flex-1 ms-3 whitespace-nowrap">О нас</span>
                </a>
            </li>
            <li>
                <a href="./achievements.html"
                   class="flex items-center p-2 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 group">
                    <svg class="flex-shrink-0 w-5 h-5 text-gray-500 transition duration-75 dark:text-gray-400 group-hover:text-gray-900 dark:group-hover:text-white"
                         aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20">
                        <path d="m17.418 3.623-.018-.008a6.713 6.713 0 0 0-2.4-.569V2h1a1 1 0 1 0 0-2h-2a1 1 0 0 0-1 1v2H9.89A6.977 6.977 0 0 1 12 8v5h-2V8A5 5 0 1 0 0 8v6a1 1 0 0 0 1 1h8v4a1 1 0 0 0 1 1h2a1 1 0 0 0 1-1v-4h6a1 1 0 0 0 1-1V8a5 5 0 0 0-2.582-4.377ZM6 12H4a1 1 0 0 1 0-2h2a1 1 0 0 1 0 2Z"/>
                    </svg>
                    <span class="flex-1 ms-3 whitespace-nowrap">Достижения</span>
                </a>
            </li>
            <li>
                <a href="./partners.html"
                   class="flex items-center p-2 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 group">
                    <svg class="flex-shrink-0 w-5 h-5 text-gray-500 transition duration-75 dark:text-gray-400 group-hover:text-gray-900 dark:group-hover:text-white"
                         aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 18">
                        <path d="M14 2a3.963 3.963 0 0 0-1.4.267 6.439 6.439 0 0 1-1.331 6.638A4 4 0 1 0 14 2Zm1 9h-1.264A6.957 6.957 0 0 1 15 15v2a2.97 2.97 0 0 1-.184 1H19a1 1 0 0 0 1-1v-1a5.006 5.006 0 0 0-5-5ZM6.5 9a4.5 4.5 0 1 0 0-9 4.5 4.5 0 0 0 0 9ZM8 10H5a5.006 5.006 0 0 0-5 5v2a1 1 0 0 0 1 1h11a1 1 0 0 0 1-1v-2a5.006 5.006 0 0 0-5-5Z"/>
                    </svg>
                    <span class="flex-1 ms-3 whitespace-nowrap">Партнеры</span>
                </a>
            </li>
            <li>
                <a href="./characteristics.html"
                   class="flex items-center p-2 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 group">
                    <svg class="flex-shrink-0 w-5 h-5 text-gray-500 transition duration-75 dark:text-gray-400 group-hover:text-gray-900 dark:group-hover:text-white"
                         aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 18 20">
                        <path d="M17 5.923A1 1 0 0 0 16 5h-3V4a4 4 0 1 0-8 0v1H2a1 1 0 0 0-1 .923L.086 17.846A2 2 0 0 0 2.08 20h13.84a2 2 0 0 0 1.994-2.153L17 5.923ZM7 9a1 1 0 0 1-2 0V7h2v2Zm0-5a2 2 0 1 1 4 0v1H7V4Zm6 5a1 1 0 1 1-2 0V7h2v2Z"/>
                    </svg>
                    <span class="flex-1 ms-3 whitespace-nowrap">Характеристики</span>
                </a>
            </li>

            <li>
                <a href="#"
                   class="flex items-center p-2 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 group">
                    <svg class="flex-shrink-0 w-5 h-5 text-gray-500 transition duration-75 dark:text-gray-400 group-hover:text-gray-900 dark:group-hover:text-white"
                         aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 18 16">
                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M1 8h11m0 0L8 4m4 4-4 4m4-11h3a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-3"/>
                    </svg>
                    <span class="flex-1 ms-3 whitespace-nowrap">Logout</span>
                </a>
            </li>
        </ul>
    </div>
</aside>
<div class="p-4 sm:ml-64 h-full">

    <div class="flex justify-between mb-6 mt-6">
        <h1 class="dark:text-white text-2xl font-bold">Создание продукта</h1>
    </div>

    <div>
        <label for="product_name" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Продукт</label>
        <input type="text" id="product_name" aria-label="disabled input 2"
               class="bg-gray-100 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 cursor-not-allowed dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-gray-400 dark:focus:ring-blue-500 dark:focus:border-blue-500"
               value="Стиральная машина / Kir yuvish moshinasi" disabled readonly>
    </div>

    <hr class="my-6"/>

    <div id="dynamic-form">
        <div>
            <div class="dark:text-white text-xl font-bold">
                <h3>
                    Изображения
                </h3>

                <div id="images" class="flex gap-4 flex-wrap mt-4">

                </div>
                <button type="button"
                        onclick="addImageField()"
                        class="mt-4 text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 me-2 mb-2 dark:bg-blue-600 dark:hover:bg-blue-700 focus:outline-none dark:focus:ring-blue-800">
                    Добавить изображение
                </button>
            </div>

            <hr class="my-6"/>

            <div class="dark:text-white text-xl font-bold">
                <h3>
                    Краткое описание с изображением
                </h3>
                <div id="descriptions" class="flex gap-4 flex-wrap">
                </div>
                <button type="button"
                        onclick="addDescriptionField()"
                        class="mt-4 text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 me-2 mb-2 dark:bg-blue-600 dark:hover:bg-blue-700 focus:outline-none dark:focus:ring-blue-800">
                    Добавить описание с изображением
                </button>
            </div>

            <hr class="my-6"/>

            <div class="dark:text-white text-xl font-bold">
                <h3>
                    Вариации
                </h3>

                <div id="variation" class="mt-4">

                </div>

                <button type="button"
                        onclick="addVariationField()"
                        class="mt-4 text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 me-2 mb-2 dark:bg-blue-600 dark:hover:bg-blue-700 focus:outline-none dark:focus:ring-blue-800">
                    Добавить вариацию
                </button>
            </div>

            <hr class="my-6"/>

            <div class="dark:text-white text-xl font-bold">
                <h3>Характеристики</h3>

                <div id="characteristics" class="mt-4">

                </div>

                <button type="button"
                        onclick="addFeatureField()"
                        class="mt-4 text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 me-2 mb-2 dark:bg-blue-600 dark:hover:bg-blue-700 focus:outline-none dark:focus:ring-blue-800">
                    Добавить характеристики
                </button>
            </div>


            <div class="mt-10">
                <button type="submit"
                        class="focus:outline-none text-white bg-green-700 hover:bg-green-800 focus:ring-4 focus:ring-green-300 font-medium rounded-lg text-sm px-5 py-2.5 me-2 mb-2 dark:bg-green-600 dark:hover:bg-green-700 dark:focus:ring-green-800">
                    Создать
                </button>
            </div>
        </div>
    </div>
</div>

<script>

    const ADD_FORM = 'ADD_FORM';
    const ADD_VARIATION_FORM = "ADD_VARIATION_FORM";
    const ADD_FEATURE_FORM = "RENDER_FEATURE_FORM";
    const SET_FORM_DATA = 'SET_FORM_DATA';
    const SET_FORM_IS_EDITING = "SET_FORM_IS_EDITING";
    const REMOVE_FORM = "REMOVE_FORM";

    const addForm = () => ({type: ADD_FORM});
    const addVariationForm = () => ({type: ADD_VARIATION_FORM});
    const addFeatureForm = () => ({type: ADD_FEATURE_FORM});
    const setFormData = (id, formData, formType) => ({type: SET_FORM_DATA, payload: {id, formData, formType}});
    const setFormIsEditing = (id, formType) => ({type: SET_FORM_IS_EDITING, payload: {id, formType}});
    const removeForm = (id, formType) => ({type: REMOVE_FORM, payload: {id, formType}});

    const initialState = {descriptionForm: [], variations: [], features: []};

    function formReducer(state = initialState, action) {
        switch (action.type) {
            case ADD_FORM:
                return {
                    ...state,
                    descriptionForm: [...state.descriptionForm, {
                        id: Date.now(),
                        data: {
                            description_ru: '',
                            description_uz: '',
                            description_image: null
                        },
                        isEditing: true
                    }]
                };
            case ADD_VARIATION_FORM:
                return {
                    ...state,
                    variations: [...state.variations, {
                        id: Date.now(),
                        data: {
                            name_ru: '',
                            name_uz: '',
                            variation_color: '',
                            variation_image: null,
                        },
                        isEditing: true
                    }]
                };
            case ADD_FEATURE_FORM:
                return {
                    ...state,
                    features: [...state.features, {
                        id: Date.now(),
                        data: {
                            feature_id: "",
                            feature_name: ""
                        },
                        isEditing: true
                    }]
                }
            case SET_FORM_DATA:
                return {
                    ...state,
                    [action.payload.formType]: state[action.payload.formType].map(form => form.id === action.payload.id ? {
                        ...form,
                        data: {...form.data, ...action.payload.formData}
                    } : form)
                };
            case SET_FORM_IS_EDITING:
                return {
                    ...state,
                    [action.payload.formType]: state[action.payload.formType].map(form => form.id === action.payload.id ? {
                        ...form,
                        isEditing: !form.isEditing
                    } : form)
                }
            case REMOVE_FORM:
                return {
                    ...state,
                    [action.payload.formType]: state[action.payload.formType].filter((form) => form.id !== action.payload.id)
                }
            default:
                return state;
        }
    }

    const store = Redux.createStore(formReducer);
    store.subscribe(renderForms);

    const addDescriptionField = () => {
        store.dispatch(addForm());
    }

    const addVariationField = () => {
        store.dispatch(addVariationForm());
    }

    const addFeatureField = () => {
        store.dispatch(addFeatureForm());
    }

    const handleChange = (id, event, formType) => {
        const name = event.target.name;
        const value = event.target.value;
        store.dispatch(setFormData(id, {[name]: value}, formType));
    }

    const handleImageChange = (id, event, formType) => {
        const name = event.target.name;
        const file = event.target.files[0];
        store.dispatch(setFormData(id, {[name]: file}, formType));
    }

    const getBase64FromImageFile = (file) => {
        if (typeof file === "string") {
            return file;
        }
        if (!file) {
            return "./assets/default-input-image.jpg";
        }
        return URL.createObjectURL(file);
    }

    const applyChanges = (id, formType, isAllFieldsFilled) => {
        if (!isAllFieldsFilled) {
            return;
        }
        store.dispatch(setFormIsEditing(id, formType));
    }

    function deleteFormById(id, formType) {
        store.dispatch(removeForm(id, formType));
    }

    const getEditDescriptionField = (
        formId,
        formImageUrl,
        formDescriptionUz,
        formDescriptionRu,
    ) => {
        const isAllFieldsFilled = formImageUrl !== "./assets/default-input-image.jpg" && (formDescriptionUz.trim().length > 0) && (formDescriptionRu.trim().length > 0);
        const btnColor = isAllFieldsFilled ? "dark:bg-green-600 dark:hover:bg-green-700 dark:focus:ring-green-800" : "dark:bg-gray-600";

        return `
                <div class="flex items-center gap-6 flex-wrap">
                    <div class="flex-1" style="min-width: 300px">
                        <div>
                            <label
                                for="description_ru_${formId}"
                                class="block mb-2 text-sm font-medium text-gray-900 dark:text-white"
                            >
                                Описание РУ
                            </label>
                            <textarea
                                onchange="handleChange(${formId}, event, 'descriptionForm')"
                                name="description_ru"
                                id="description_ru_${formId}"
                                rows="4"
                                class="description_fields block p-2.5 w-full text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500"
                            >${formDescriptionRu}</textarea>
                        </div>
                        <div class="mt-4">
                            <label
                                for="description_uz_${formId}"
                                class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">
                                Описание УЗ
                            </label>
                            <textarea
                                onchange="handleChange(${formId}, event, 'descriptionForm')"
                                name="description_uz"
                                id="description_uz_${formId}"
                                rows="4"
                                class="description_fields block p-2.5 w-full text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500"
                            >${formDescriptionUz}</textarea>
                        </div>
                    </div>
                    <div class="max-w-96" style="height: 250px;width: 300px;">
                        <label for="description_image_${formId}">
                            <img
                                class="w-full h-full object-cover cursor-pointer"
                                src="${formImageUrl}"
                                id="image_${formId}"
                                alt=""
                            />
                        </label>
                        <input
                            name="description_image"
                            class="description_fields hidden"
                            id="description_image_${formId}"
                            type="file"
                            onchange="handleImageChange(${formId}, event, 'descriptionForm')"/>
                    </div>
                </div>
                <button
                    type="button"
                    onclick="deleteFormById(${formId}, 'descriptionForm')"
                    class="mt-4 focus:outline-none text-white bg-red-700 hover:bg-red-800 focus:ring-4 focus:ring-red-300 font-medium rounded-lg text-sm px-5 py-2.5 me-2 mb-2 dark:bg-red-600 dark:hover:bg-red-700 dark:focus:ring-red-900"
                >
                    Удалить
                </button>
                <button
                    type="button"
                    class="apply-button focus:outline-none text-white bg-green-700 hover:bg-green-800 focus:ring-4 focus:ring-green-300 font-medium rounded-lg text-sm px-5 py-2.5 me-2 mb-2 ${btnColor}"
                    onclick="applyChanges(${formId}, 'descriptionForm', ${isAllFieldsFilled})"
                >
                    Применить
                </button>
            `;
    }


    const getDescriptionField = (
        formImageUrl,
        formId,
        formDescriptionRu,
        formDescriptionUz,
    ) => {
        return (`
                <div class="flex items-center gap-6 flex-wrap">
                    <div class="flex-1" style="min-width: 300px">
                        <div>
                            <label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Описание РУ</label>
                            <p class="block p-2.5 w-full text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 dark:bg-gray-700 dark:border-gray-600 dark:text-white">${formDescriptionRu}</p>
                        </div>
                        <div class="mt-4">
                            <label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Описание Уз</label>
                            <p class="block p-2.5 w-full text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 dark:bg-gray-700 dark:border-gray-600 dark:text-white">${formDescriptionUz}</p>
                        </div>
                    </div>
                    <div class="max-w-96" style="height: 250px;width: 300px;">
                        <img class="w-full h-full object-cover" src="${formImageUrl}" alt=""/>
                    </div>
                </div>
                <button
                    type="button"
                    class="edit-button focus:outline-none text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 me-2 mb-2 dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800"
                    onclick="applyChanges(${formId}, 'descriptionForm', true)"
                >
                    Редактировать
                </button>
            `
        )
    }

    const renderDescriptionForms = (state) => {
        const descriptionsDiv = document.getElementById('descriptions');
        descriptionsDiv.innerHTML = '';
        state.descriptionForm.forEach(form => {
            const descriptionImage = form.data.description_image;
            const formActionUrl = form.data.id ? `/url/${form.data.id}` : "/url";
            const formElement = document.createElement('form');
            formElement.classList.add('w-full', 'mt-4');

            formElement.method = 'POST';
            formElement.action = formActionUrl;

            const imageUrl = getBase64FromImageFile(descriptionImage);
            if (form.isEditing) {
                formElement.innerHTML = getEditDescriptionField(form.id, imageUrl, form.data.description_uz, form.data.description_ru);
            } else {
                formElement.innerHTML = getDescriptionField(imageUrl, form.id, form.data.description_ru, form.data.description_uz);
            }
            descriptionsDiv.appendChild(formElement);
        });
    }


    const getEditVariationField = (
        formId,
        formNameRu,
        formNameUz,
        formVariationColor,
        formImageUrl,
    ) => {
        const isAllFieldsFilled = formImageUrl !== "./assets/default-input-image.jpg" && (formNameRu.trim().length > 0) && (formNameUz.trim().length > 0) && (formVariationColor.trim().length > 0);
        const btnColor = isAllFieldsFilled ? "dark:bg-green-600 dark:hover:bg-green-700 dark:focus:ring-green-800" : "dark:bg-gray-600";

        return (`
            <div class="flex flex-wrap gap-6 w-full">
                <div class="flex-1">
                    <div class="mb-5">
                        <label
                            for="name_ru_${formId}"
                            class="block mb-2 text-sm font-medium text-gray-900 dark:text-white"
                        >Название РУ</label>
                        <input
                            name="name_ru"
                            type="text"
                            id="name_ru_${formId}"
                            value="${formNameRu}"
                            onchange="handleChange(${formId}, event, 'variations')"
                            class="variaion_fields bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500"
                        >
                    </div>
                    <div class="mb-5">
                        <label
                            for="name_uz_${formId}"
                            class="block mb-2 text-sm font-medium text-gray-900 dark:text-white"
                        >Название УЗ</label>
                        <input
                            name="name_uz"
                            type="text"
                            id="name_uz_${formId}"
                            class="variaion_fields bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500"
                            value="${formNameUz}"
                            onchange="handleChange(${formId}, event, 'variations')"
                        >
                    </div>
                    <div>
                        <input
                            name="variation_color"
                            type="color"
                            name="color"
                            class="variation_fields"
                            value="${formVariationColor}"
                            onchange="handleChange(${formId}, event, 'variations')"
                        />
                    </div>
                </div>
                <div class="max-w-96" style="height: 250px;width: 300px;">
                    <label for="variation_image_${formId}">
                        <img
                            class="w-full h-full object-cover cursor-pointer"
                            src="${formImageUrl}"
                            id="image-${formId}"
                            alt="image-${formId}"
                        />
                    </label>
                    <input
                        name="variation_image"
                        class="variaion_fields hidden"
                        id="variation_image_${formId}"
                        type="file"
                        onchange="handleImageChange(${formId}, event, 'variations')"
                    />
               </div>
            </div>
            <button
                type="button"
                onclick="deleteFormById(${formId}, 'variations')"
                class="mt-4 focus:outline-none text-white bg-red-700 hover:bg-red-800 focus:ring-4 focus:ring-red-300 font-medium rounded-lg text-sm px-5 py-2.5 me-2 mb-2 dark:bg-red-600 dark:hover:bg-red-700 dark:focus:ring-red-900"
            >
                Удалить
            </button>
            <button
                type="button"
                class="apply-button focus:outline-none text-white bg-green-700 hover:bg-green-800 focus:ring-4 focus:ring-green-300 font-medium rounded-lg text-sm px-5 py-2.5 me-2 mb-2 ${btnColor}"
                onclick="applyChanges(${formId}, 'variations', ${isAllFieldsFilled})"
            >
                Применить
            </button>
            `
        );
    }

    const getVariationField = (
        formId,
        formNameRu,
        formNameUz,
        formVariationColor,
        formImageUrl,
    ) => {

        return (`
            <div class="flex flex-wrap gap-6 w-full">
                <div class="flex-1">
                    <div class="mb-5">
                        <label
                            class="block mb-2 text-sm font-medium text-gray-900 dark:text-white"
                        >Название РУ</label>
                        <p
                            onchange="handleChange(${formId}, event, 'variations')"
                            class="variaion_fields bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500"
                        >${formNameRu}</p>
                    </div>
                    <div class="mb-5">
                        <label
                            class="block mb-2 text-sm font-medium text-gray-900 dark:text-white"
                        >Название УЗ</label>
                        <p
                            class="variaion_fields bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500"
                            onchange="handleChange(${formId}, event, 'variations')"
                        >${formNameUz}</p>
                    </div>
                    <div>
                        <input
                            name="variation_color"
                            type="color"
                            name="color"
                            class="variation_fields"
                            disabled
                            value="${formVariationColor}"
                        />
                    </div>
                </div>
                <div class="max-w-96" style="height: 250px;width: 300px;">
                    <img
                        class="w-full h-full object-cover"
                        src="${formImageUrl}"
                        id="image-${formId}"
                        alt="image-${formId}"
                    />
               </div>
            </div>
            <button
                type="button"
                class="edit-button focus:outline-none text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 me-2 mb-2 dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800"
                onclick="applyChanges(${formId}, 'variations', true)"
            >
                Редактировать
            </button>
            `
        );
    }

    const renderVariationForms = (state) => {
        const variationList = document.getElementById('variation');
        variationList.innerHTML = '';
        state.variations.forEach(form => {
            const variationImage = form.data.variation_image;
            const formActionUrl = form.data.id ? `/url/${form.data.id}` : "/url";
            const formElement = document.createElement('form');
            formElement.classList.add('w-full', 'mt-4');

            formElement.method = 'POST';
            formElement.action = formActionUrl;
            const imageUrl = getBase64FromImageFile(variationImage);
            if (form.isEditing) {
                formElement.innerHTML = getEditVariationField(form.id, form.data.name_ru, form.data.name_uz, form.data.variation_color, imageUrl);
            } else {
                formElement.innerHTML = getVariationField(form.id, form.data.name_ru, form.data.name_uz, form.data.variation_color, imageUrl);
            }
            variationList.appendChild(formElement);
        });
    }

    const getFeatureField = (
        formId,
        formFeatureId,
        formFeatureName
    ) => {

        return `
            <div class="flex gap-4 my-2">
                <select
                    onchange="handleChange(${formId}, event, 'features')"
                    name="feature_id"
                    value="${formFeatureId}"
                    disabled
                    class="feature_fields bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500"
                >
                    <option selected disabled>Выберите характеристики</option>
                    <option value="US" ${formFeatureId === "US" ? "selected" : ""}>United States</option>
                    <option value="CA" ${formFeatureId === "CA" ? "selected" : ""}>Canada</option>
                    <option value="FR" ${formFeatureId === "FR" ? "selected" : ""}>France</option>
                    <option value="DE" ${formFeatureId === "DE" ? "selected" : ""}>Germany</option>
                </select>
                <p
                    class="feature_fields bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500"
                >${formFeatureName}</p>
            </div>
            <button
                type="button"
                class="edit-button focus:outline-none text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 me-2 mb-2 dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800"
                onclick="applyChanges(${formId}, 'features', true)"
            >
                Редактировать
            </button>
        `;
    }

    const getEditFeatureField = (
        formId,
        formFeatureId,
        formFeatureName
    ) => {
        const isAllFieldsFilled = (formFeatureId.trim().length > 0) && (formFeatureName.trim().length > 0);
        const btnColor = isAllFieldsFilled ? "dark:bg-green-600 dark:hover:bg-green-700 dark:focus:ring-green-800" : "dark:bg-gray-600";

        return `
            <div class="flex gap-4 my-2">
                <select
                    onchange="handleChange(${formId}, event, 'features')"
                    name="feature_id"
                    value="${formFeatureId}"
                    class="feature_fields bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500"
                >
                    <option selected disabled>Выберите характеристики</option>
                    <option value="US" ${formFeatureId === "US" ? "selected": ""}>United States</option>
                    <option value="CA" ${formFeatureId === "CA" ? "selected": ""}>Canada</option>
                    <option value="FR" ${formFeatureId === "FR" ? "selected": ""}>France</option>
                    <option value="DE" ${formFeatureId === "DE" ? "selected": ""}>Germany</option>
                </select>
                <input
                    value="${formFeatureName}"
                    onchange="handleChange(${formId}, event, 'features')"
                    name="feature_name"
                    type="text"
                    class="feature_fields bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500"
                >
            </div>
             <button
                type="button"
                onclick="deleteFormById(${formId}, 'features')"
                class="mt-4 focus:outline-none text-white bg-red-700 hover:bg-red-800 focus:ring-4 focus:ring-red-300 font-medium rounded-lg text-sm px-5 py-2.5 me-2 mb-2 dark:bg-red-600 dark:hover:bg-red-700 dark:focus:ring-red-900"
            >
                Удалить
            </button>
            <button
                type="button"
                class="apply-button focus:outline-none text-white bg-green-700 hover:bg-green-800 focus:ring-4 focus:ring-green-300 font-medium rounded-lg text-sm px-5 py-2.5 me-2 mb-2 ${btnColor}"
                onclick="applyChanges(${formId}, 'features', ${isAllFieldsFilled})"
            >
                Применить
            </button>
        `;
    }

    function renderFeatureForms(state) {
        const featuresList = document.getElementById('characteristics');
        featuresList.innerHTML = '';
        state.features.forEach(form => {
            const formActionUrl = form.data.id ? `/url/${form.data.id}` : "/url";
            const formElement = document.createElement('form');
            formElement.classList.add('w-full', 'mt-4');

            formElement.method = 'POST';
            formElement.action = formActionUrl;

            if (form.isEditing) {
                formElement.innerHTML = getEditFeatureField(form.id, form.data.feature_id, form.data.feature_name);
            } else {
                formElement.innerHTML = getFeatureField(form.id, form.data.feature_id, form.data.feature_name);
            }
            featuresList.appendChild(formElement);
        });
    }

    function renderForms() {
        const state = store.getState();
        renderDescriptionForms(state);
        renderVariationForms(state);
        renderFeatureForms(state);
    }

    function addImageField() {
        const container = document.createElement('form');
        const uniqueId = `file-${Math.random().toString(36).substr(2, 9)}`;

        container.action = "/123";
        container.method = "POST";

        container.innerHTML = `
            <div class="w-full max-w-96" style="height: 250px;max-width: 400px;">
                <label for="${uniqueId}">
                    <img class="w-full h-full object-cover cursor-pointer" src="./assets/default-input-image.jpg" id="image-${uniqueId}" alt="image"/>
                </label>
                <input name="image" class="images hidden" id="${uniqueId}" type="file" onchange="previewImage(this, '${uniqueId}')"/>
            </div>
            <button
                type="button"
                onclick="this.parentElement.remove()"
                class="mt-4 focus:outline-none text-white bg-red-700 hover:bg-red-800 focus:ring-4 focus:ring-red-300 font-medium rounded-lg text-sm px-5 py-2.5 me-2 mb-2 dark:bg-red-600 dark:hover:bg-red-700 dark:focus:ring-red-900"
            >
                Удалить
            </button>
        `;
        document.getElementById('images').appendChild(container);
    }

    document.body.addEventListener('blur', function (event) {
        if ((event.target.tagName === 'INPUT' && event.target.type !== 'file') || event.target.tagName === 'TEXTAREA' || event.target.tagName === 'SELECT') {
            sendData(event.target);
        }
    }, true);

    document.body.addEventListener('change', function (event) {
        if (event.target.type === 'file' || event.target.tagName === 'SELECT') {
            sendData(event.target);
        }
    });

    function sendData(element) {
        const formData = new FormData();
        if (element.type === 'file' && element.files.length > 0) {
            formData.append(element.name, element.files[0]);
        } else {
            formData.append(element.name, element.value);
        }

        fetch(element.form.action, {
            method: 'POST',
            body: formData
        }).then(response => response.json())
            .then(data => {
                console.log('Data sent successfully', data);
            }).catch(error => console.error('Error:', error));
    }
</script>
</body>
</html>
